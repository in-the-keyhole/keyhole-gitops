apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: cloudfront-distribution
  labels:
    provider: aws
    crossplane.io/xrd: xdistributions.cloudfront.keyholesoftware.com
spec:
  compositeTypeRef:
    apiVersion: cloudfront.keyholesoftware.com/v1alpha1
    kind: XDistribution
  resources:

  - name: s3_bucket
    base:
      apiVersion: s3.aws.upbound.io/v1beta1
      kind: Bucket
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.labels[crossplane.io/claim-name]
      toFieldPath: metadata.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.arn
      toFieldPath: status.bucketArn
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.bucketName
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.websiteEndpoint
      toFieldPath: status.bucketWebsiteEndpoint

  - name: s3_bucket_policy
    base:
      apiVersion: s3.aws.upbound.io/v1beta1
      kind: BucketPolicy
      spec:
        forProvider:
          policy: > # will be patched with resolved values
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                    "Sid": "PublicReadGetObject",
                    "Effect": "Allow",
                    "Principal": "*",
                    "Action": "s3:GetObject",
                    "Resource": "patchWithBucketArn/*"
                }
              ]
            }
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.labels[crossplane.io/claim-name]
      toFieldPath: spec.forProvider.bucketRef.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: status.bucketArn
        strategy: string
        string:
          fmt: >
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                    "Sid": "PublicReadGetObject",
                    "Effect": "Allow",
                    "Principal": "*",
                    "Action": "s3:GetObject",
                    "Resource": "%s/*"
                }
              ]
            }
      toFieldPath: spec.forProvider.policy

  - name: s3_bucket_website_configuration
    base:
      apiVersion: s3.aws.upbound.io/v1beta1
      kind: BucketWebsiteConfiguration
      spec:
        forProvider:
          errorDocument:
            - key: error.html
          indexDocument:
            - suffix: index.html
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.labels[crossplane.io/claim-name]
      toFieldPath: spec.forProvider.bucketRef.name

  - name: distribution
    base:
      apiVersion: cloudfront.aws.upbound.io/v1beta1
      kind: Distribution
      spec:
        forProvider:
          aliases:
            - will.be.patched
          defaultCacheBehavior:
          - allowedMethods:
            - DELETE
            - GET
            - HEAD
            - OPTIONS
            - PATCH
            - POST
            - PUT
            cachedMethods:
            - GET
            - HEAD
            defaultTtl: 3600
            forwardedValues:
            - cookies:
              - forward: none
              queryString: false
            maxTtl: 86400
            minTtl: 0
            targetOriginId: s3_origin
            viewerProtocolPolicy: redirect-to-https
            compress: true
          defaultRootObject: index.html
          enabled: true
          isIpv6Enabled: true
          origin:
          - originId: s3_origin
            domainName: will.be.patched
            customOriginConfig:
            - httpPort: 80
              httpsPort: 443
              originProtocolPolicy: http-only
              originSslProtocols:
                - TLSv1
                - TLSv1.1
                - TLSv1.2
          priceClass: PriceClass_100
          restrictions:
          - geoRestriction:
            - locations:
              - US
              restrictionType: whitelist
          viewerCertificate:
          - cloudfrontDefaultCertificate: false
            acmCertificateArn: arn:aws:acm:us-east-1:999330780379:certificate/95bc1cd7-4d73-4499-9a64-8f883d551c56
            sslSupportMethod: sni-only
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: metadata.labels[crossplane.io/claim-name]
      toFieldPath: spec.forProvider.bucketRef.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: metadata.labels[crossplane.io/claim-name]
        - fromFieldPath: spec.parameters.dnsSuffix
        strategy: string
        string:
          fmt: "%s.%s"
      toFieldPath: spec.forProvider.aliases[0]
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: status.bucketWebsiteEndpoint
        strategy: string
        string:
          fmt: "%s"
      toFieldPath: spec.forProvider.origin[0].domainName
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.distributionId
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.domainName
      toFieldPath: status.distributionDomainName

  - name: route53_record
    base:
      apiVersion: route53.aws.upbound.io/v1beta1
      kind: Record
      spec:
        forProvider:
          type: A
          zoneId: Z01786413D3NWMNM4V0CR
          name: will.be.patched
          region: us-east-1
          alias:
            - name: patch.keyhole.institute
              zoneId: Z2FDTNDATAQYW2
              evaluateTargetHealth: false
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: status.distributionDomainName
      toFieldPath: spec.forProvider.alias[0].name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: metadata.labels[crossplane.io/claim-name]
        - fromFieldPath: spec.parameters.dnsSuffix
        strategy: string
        string:
          fmt: "%s.%s"
      toFieldPath: spec.forProvider.name

  # - name: github_action_secret
  #   base:
  #     apiVersion: tf.upbound.io/v1beta1
  #     kind: Workspace
  #     spec:
  #       forProvider:
  #         module: |
  #           resource "github_actions_secret" "cloudfront_distribution_id" {
  #             repository      = "keyhole-demo"
  #             secret_name     = "CLOUDFRONT_DISTRIBUTION_ID"
  #             plaintext_value = "KDAJFDAKLFDLKAJ"
  #           }

  #           output "created_at" {
  #             value = github_actions_secret.cloudfront_distribution_id.created_at
  #           }
  #         source: Inline

  # - name: github_action_secret_from_env
  #   base:
  #     apiVersion: tf.upbound.io/v1beta1
  #     kind: Workspace
  #     spec:
  #       forProvider:
  #         module: ""
  #         source: Inline
  #   patches:
  #   # - type: FromCompositeFieldPath
  #   #   fromFieldPath: metadata.labels[crossplane.io/claim-name]
  #   #   toFieldPath: metadata.name
  #   - type: CombineFromEnvironment
  #     combine:
  #       variables:
  #       - fromFieldPath: 
  #       - fromFieldPath: 
  #       - fromFieldPath: metadata.labels[crossplane.io/claim-name]
  #       - fromFieldPath:
  #       strategy: string
  #       string:
  #         fmt: >
  #           resource "github_actions_secret" "aws_access_key_id" {
  #             repository      = "%s"
  #             secret_name     = "AWS_ACCESS_KEY_ID"
  #             plaintext_value = "%s"
  #           }
  #           resource "github_actions_secret" "aws_secret_access_key" {
  #             repository      = "%s"
  #             secret_name     = "AWS_SECRET_ACCESS_KEY"
  #             plaintext_value = "%s"
  #           }
  #     toFieldPath: spec.forProvider.module

  - name: github_action_secret_from_composite
    base:
      apiVersion: tf.upbound.io/v1beta1
      kind: Workspace
      spec:
        forProvider:
          module: ""
          source: Inline
    patches:
    # - type: FromCompositeFieldPath
    #   fromFieldPath: metadata.labels[crossplane.io/claim-name]
    #   toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
        - fromFieldPath: metadata.labels[crossplane.io/claim-name]
        - fromFieldPath: metadata.labels[crossplane.io/claim-name]
        - fromFieldPath: metadata.labels[crossplane.io/claim-name]
        - fromFieldPath: spec.parameters.region
        - fromFieldPath: metadata.labels[crossplane.io/claim-name]
        - fromFieldPath: status.bucketName
        - fromFieldPath: metadata.labels[crossplane.io/claim-name]
        - fromFieldPath: status.distributionId
        strategy: string
        string:
          fmt: >
            resource "github_actions_secret" "aws_access_key_id" {
              repository      = "%s"
              secret_name     = "AWS_ACCESS_KEY_ID"
              encrypted_value = "8bPLmKt0qX0wQomG87RgShGADfXotCNxlk5lutgfwH2evadYPLaIazbsuwFvZT/F7WDuo2D0PTyt+PlFIunRX6y/cfo="
            }

            resource "github_actions_secret" "aws_secret_access_key" {
              repository      = "%s"
              secret_name     = "AWS_SECRET_ACCESS_KEY"
              encrypted_value = "5yFmKiXYoSNDciJKimXGZk4fi47J1/dPIZahF+kBIjWIquqNliFMuZ3ZZANhdpyT2LZLCtGkk3wjHL05NfvYRAO7ED/ADYQ9YltwoVkQW1vEZMy/cmepvQ=="
            }

            resource "github_actions_secret" "aws_default_region" {
              repository      = "%s"
              secret_name     = "AWS_DEFAULT_REGION"
              plaintext_value = "%s"
            }

            resource "github_actions_secret" "s3_bucket" {
              repository      = "%s"
              secret_name     = "S3_BUCKET"
              plaintext_value = "%s"
            }

            resource "github_actions_secret" "cloudfront_distribution_id" {
              repository      = "%s"
              secret_name     = "CLOUDFRONT_DISTRIBUTION_ID"
              plaintext_value = "%s"
            }
      toFieldPath: spec.forProvider.module